<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HoangMinhOfficial Chat</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#0d1117;
  color:#e6edf3;
  display:flex;
  flex-direction:column;
  height:100vh;
}

.header{
  padding:14px;
  background:#161b22;
  text-align:center;
  font-weight:bold;
  border-bottom:1px solid #30363d;
}

#messages{
  flex:1;
  padding:16px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.msg{
  max-width:70%;
  padding:12px 14px;
  border-radius:14px;
  background:#21262d;
  font-size:14px;
  position:relative;
  word-wrap:break-word;
}

.me{
  align-self:flex-end;
  background:#238636;
  color:white;
}

.sender{
  font-size:11px;
  opacity:.7;
  margin-bottom:4px;
}

.delete{
  position:absolute;
  top:6px;
  right:8px;
  cursor:pointer;
  font-size:12px;
  opacity:.6;
}
.delete:hover{opacity:1}

#typing{
  font-size:12px;
  color:#8b949e;
  padding:4px 16px;
}

.inputBar{
  display:flex;
  padding:10px;
  background:#161b22;
  border-top:1px solid #30363d;
}

input{
  flex:1;
  padding:12px;
  border-radius:8px;
  border:none;
  background:#0d1117;
  color:#e6edf3;
  outline:none;
}

button{
  margin-left:10px;
  padding:12px 18px;
  border:none;
  border-radius:8px;
  background:#238636;
  color:white;
  font-weight:bold;
  cursor:pointer;
}

/* ONLINE BOX */
.onlineBox{
  position:fixed;
  top:12px;
  left:12px;
  background:#161b22;
  border:1px solid #30363d;
  border-radius:10px;
  padding:10px;
  width:180px;
  font-size:13px;
  box-shadow:0 8px 20px rgba(0,0,0,.4);
}
.onlineBox h4{
  margin:0 0 8px;
  font-size:13px;
  color:#8b949e;
}
.onlineUser{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
</style>
</head>

<body>

<div class="onlineBox">
  <h4>ðŸŸ¢ Online</h4>
  <div id="onlineList"></div>
</div>

<div class="header">ðŸ’¬ Global Chat</div>
<div id="messages"></div>
<div id="typing"></div>

<div class="inputBar">
  <input id="text" placeholder="Nháº­p tin nháº¯n...">
  <button onclick="send()">Gá»­i</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, orderBy,
  onSnapshot, serverTimestamp, deleteDoc, doc, setDoc
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCiroMCXbxEt3_kZ_AcV5nmRW88b7P3R4Y",
  authDomain: "hoangminhofficial.firebaseapp.com",
  projectId: "hoangminhofficial"
};

const ADMIN = "minhminh2532013@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let user=null;

onAuthStateChanged(auth,u=>{
  if(!u){ location.href="index.html"; return; }
  user=u;

  setDoc(doc(db,"online",user.uid),{
    email:user.email,
    time:serverTimestamp()
  });

  loadMessages();
  watchTyping();
  watchOnline();
});

window.addEventListener("beforeunload",()=>{
  if(user){
    deleteDoc(doc(db,"online",user.uid));
  }
});

function loadMessages(){
  const q=query(collection(db,"messages"),orderBy("time","asc"));
  onSnapshot(q,snap=>{
    messages.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg"+(m.uid===user.uid?" me":"");
      div.innerHTML=`
        <div class="sender">${m.email}</div>
        ${m.text}
        ${user.email===ADMIN?`<div class="delete">ðŸ—‘</div>`:""}
      `;
      if(user.email===ADMIN){
        div.querySelector(".delete")?.addEventListener("click",()=>{
          deleteDoc(doc(db,"messages",d.id));
        });
      }
      messages.appendChild(div);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}

window.send=async()=>{
  if(!text.value.trim()) return;
  await addDoc(collection(db,"messages"),{
    text:text.value,
    uid:user.uid,
    email:user.email,
    time:serverTimestamp()
  });
  text.value="";
  setTyping("");
};

text.addEventListener("input",()=>{
  setTyping(user.email);
});

function setTyping(email){
  setDoc(doc(db,"typing","global"),{
    email,
    time:serverTimestamp()
  });
}

function watchTyping(){
  onSnapshot(doc(db,"typing","global"),snap=>{
    const d=snap.data();
    if(d && d.email && d.email!==user.email){
      typing.innerText=d.email+" Ä‘ang nháº­p...";
    } else typing.innerText="";
  });
}

function watchOnline(){
  onSnapshot(collection(db,"online"),snap=>{
    onlineList.innerHTML="";
    snap.forEach(d=>{
      const div=document.createElement("div");
      div.className="onlineUser";
      div.innerText="â€¢ "+d.data().email;
      onlineList.appendChild(div);
    });
  });
}
</script>

</body>
</html>
